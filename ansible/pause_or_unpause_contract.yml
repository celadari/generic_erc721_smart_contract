# Copyright 2019 celadari. All rights reserved. MIT license.
---
- name: Pause smart contract
  hosts: localhost
  gather_facts: yes
  connection: local
  vars:
    - env: dev
    - pause_or_unpause: pause
  vars_files:
    - "./vars/{{ env }}/vars.yml"
    - "./vars/{{ env }}/vault"
  environment:
    BLOCKCHAIN_HOST: "{{ blockchain_host }}"
    BLOCKCHAIN_PORT: "{{ blockchain_port_outside_container }}"
    BLOCKCHAIN_NETWORK_ID: "{{ blockchain_network_id }}"
    PROVIDER_MNEMONIC_PHRASE: "{{ smart_contract_pauser_key_mnemonic }}"
  tasks:
    - name: Retrieve 'smart_contract_address'
      postgresql_query:
        login_host: "{{ db_host }}"
        db: "{{ db_database }}"
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        port: "{{ db_port }}"
        query: "SELECT address FROM smart_contracts;"
      register: smart_contracts_address_query
    - name: Set fact smart_contracts_address
      ansible.builtin.set_fact:
        smart_contracts_address: "{{ smart_contracts_address_query['query_result'][0]['address'] }}"
    - name: Pause or unpause contract
      command: "npx truffle exec --action={{pause_or_unpause}} --network={{blockchain_network}} --froms={{smart_contract_admin_accounts}} --fromIndex=0 --smartContractAddress={{smart_contracts_address}} scripts/stages/deploy/sendGrantRole.js"
      args:
        chdir: "{{ playbook_dir }}/.."
